<!DOCTYPE html>
<html lang="en" data-theme="<%= data.options.theme %>">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= data.metadata.title %></title>
    <style>
      :root {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color-scheme: light dark;
      }
      body {
        margin: 0;
        padding: 24px;
        background: var(--surface, #f5f7fb);
        color: var(--text, #1a1f36);
      }
      [data-theme='dark'] {
        --surface: #0f172a;
        --card: #1e293b;
        --card-border: rgba(255, 255, 255, 0.08);
        --text: #f8fafc;
        --muted: #94a3b8;
      }
      [data-theme='light'] {
        --surface: #f5f7fb;
        --card: #ffffff;
        --card-border: rgba(15, 23, 42, 0.06);
        --text: #0f172a;
        --muted: #475569;
      }
      h1,
      h2,
      h3 {
        margin-top: 0;
        color: var(--text);
      }
      section {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 18px;
        padding: 20px 24px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      .grid.cols-3 {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
        font-size: 12px;
        font-weight: 600;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--card-border);
      }
      th {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .status-pill {
        padding: 2px 10px;
        border-radius: 999px;
        font-weight: 600;
        text-transform: capitalize;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
      }
      .status-pill.pass {
        background: rgba(34, 197, 94, 0.15);
        color: #15803d;
      }
      .status-pill.fail {
        background: rgba(248, 113, 113, 0.18);
        color: #b91c1c;
      }
      .status-pill.skip {
        background: rgba(226, 232, 240, 0.5);
        color: #475569;
      }
      .metrics-card {
        border-radius: 16px;
        border: 1px solid var(--card-border);
        padding: 16px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), transparent);
      }
      .metrics-card h3 {
        font-size: 32px;
        margin: 0;
      }
      .muted {
        color: var(--muted);
      }
      .chip {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
        color: var(--text);
        font-size: 13px;
        margin-right: 6px;
        margin-bottom: 6px;
      }
      details summary {
        cursor: pointer;
        font-weight: 600;
      }
      .screenshot {
        border-radius: 12px;
        border: 1px solid var(--card-border);
        margin-top: 12px;
        max-width: 100%;
      }
      .two-column {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }
    </style>
    <script>
      <%- chartScript %>
    </script>
  </head>
  <body data-theme="<%= data.options.theme %>">
    <% const mode = (data.options.reportType || 'full').toLowerCase(); %>
    <% const showSection = (...allowed) => mode === 'full' || allowed.includes(mode); %>
    <header style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;">
      <div>
        <div class="badge">Playwright PDF Reporter v<%= data.reporterVersion %></div>
        <h1 style="margin:8px 0 4px 0;"><%= data.metadata.title %></h1>
        <p class="muted">
          Authored by <strong><%= data.metadata.author %></strong> • Build <%= data.metadata.build %> •
          Environment <%= data.metadata.environment %>
        </p>
        <% if (data.metadata.ciLink) { %>
          <a href="<%= data.metadata.ciLink %>" class="badge">View CI Pipeline</a>
        <% } %>
      </div>
      <div style="text-align:right;">
        <p class="muted">Executed <%= helpers.toDateTimeString(data.summary.startTime) %></p>
        <p class="muted">Duration <%= helpers.formatDuration(data.summary.durationMs) %></p>
        <% if (data.metadata.tags.length) { %>
          <div>
            <% data.metadata.tags.forEach(tag => { %>
              <span class="chip"><%= tag %></span>
            <% }) %>
          </div>
        <% } %>
      </div>
    </header>

    <% if (showSection('summary', 'execution')) { %>
      <section>
        <h2>Test Scope & Objectives</h2>
        <div class="grid cols-3">
          <div>
            <h3>Objectives</h3>
            <ul>
              <% data.scope.objectives.forEach(item => { %>
                <li><%= item %></li>
              <% }) %>
            </ul>
          </div>
          <div>
            <h3>Data Sets</h3>
            <ul>
              <% data.scope.dataSets.forEach(item => { %>
                <li><%= item %></li>
              <% }) %>
            </ul>
          </div>
          <div>
            <h3>Pass / Fail Criteria</h3>
            <ul>
              <% data.scope.passCriteria.forEach(item => { %>
                <li><%= item %></li>
              <% }) %>
            </ul>
          </div>
        </div>
        <h3>Risks & Alignment</h3>
        <p><%= data.scope.alignment %></p>
        <ul>
          <% data.scope.risks.forEach(item => { %>
            <li><%= item %></li>
          <% }) %>
        </ul>
      </section>
    <% } %>

    <% if (showSection('summary', 'execution')) { %>
      <section>
        <h2>Execution Summary</h2>
        <div class="grid cols-3">
          <div class="metrics-card">
            <p class="muted">Total Tests</p>
            <h3><%= helpers.formatNumber(data.summary.total) %></h3>
          </div>
          <div class="metrics-card">
            <p class="muted">Passed</p>
            <h3 style="color:#16a34a;"><%= helpers.formatNumber(data.summary.passed) %></h3>
            <small><%= helpers.percent(data.summary.passed, data.summary.total) %>%</small>
          </div>
          <div class="metrics-card">
            <p class="muted">Failed</p>
            <h3 style="color:#dc2626;"><%= helpers.formatNumber(data.summary.failed) %></h3>
            <small><%= helpers.percent(data.summary.failed, data.summary.total) %>%</small>
          </div>
        </div>
        <div class="two-column" style="margin-top:20px; align-items:center;">
          <canvas id="statusChart" height="220"></canvas>
          <div>
            <p class="muted">Build / Environment Details</p>
            <p><strong>Build:</strong> <%= data.metadata.build %></p>
            <p><strong>Release:</strong> <%= data.metadata.release %></p>
            <p><strong>Project:</strong> <%= data.metadata.project %></p>
          </div>
        </div>
      </section>
    <% } %>

    <% if (showSection('summary', 'execution')) { %>
      <section>
        <h2>Automation Metrics</h2>
        <div class="grid cols-3">
          <div>
            <p class="muted">Coverage</p>
            <h1><%= data.metrics.coveragePercent %>%</h1>
          </div>
          <div>
            <p class="muted">Reliability</p>
            <h1><%= data.metrics.reliabilityScore %>%</h1>
          </div>
          <div>
            <p class="muted">Maintainability</p>
            <h1><%= data.metrics.maintainabilityIndex %>%</h1>
          </div>
        </div>
        <canvas id="metricsChart" height="160"></canvas>
      </section>
    <% } %>

    <% if (showSection('execution', 'defect')) { %>
      <section>
        <h2>Test Case Details</h2>
        <table>
          <thead>
            <tr>
              <th>Test</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Annotations</th>
            </tr>
          </thead>
          <tbody>
            <% data.cases.forEach(test => { %>
              <tr>
                <td>
                  <strong><%= test.title %></strong>
                  <p class="muted"><%= test.path %></p>
                  <% if (test.steps.length) { %>
                    <details>
                      <summary>Steps</summary>
                      <ul>
                        <% test.steps.forEach(step => { %>
                          <li><%= step %></li>
                        <% }) %>
                      </ul>
                    </details>
                  <% } %>
                </td>
                <td>
                  <span class="status-pill <%= test.status === 'passed' ? 'pass' : test.status === 'skipped' ? 'skip' : 'fail' %>">
                    <%= test.status %>
                  </span>
                </td>
                <td><%= helpers.formatDuration(test.duration) %></td>
                <td>
                  <% Object.entries(test.annotations).forEach(([key, value]) => { %>
                    <span class="chip"><%= key %>: <%= value %></span>
                  <% }) %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </section>
    <% } %>

    <% if (data.failures.length && showSection('execution', 'defect')) { %>
      <section>
        <h2>Failure & Defect Analysis</h2>
        <% data.failures.forEach(failure => { %>
          <article style="border:1px solid var(--card-border);border-radius:14px;padding:16px;margin-bottom:16px;">
            <header style="display:flex;justify-content:space-between;">
              <div>
                <h3 style="margin-bottom:4px;"><%= failure.title %></h3>
                <p class="muted"><%= failure.path %></p>
              </div>
              <div>
                <% failure.errors.forEach(error => { %>
                  <span class="status-pill fail"><%= error.category %></span>
                <% }) %>
              </div>
            </header>
            <% failure.errors.forEach(error => { %>
              <p><strong>Error:</strong> <%= error.message %></p>
              <% if (error.stack) { %>
                <pre style="white-space:pre-wrap;background:rgba(15,23,42,0.06);padding:12px;border-radius:12px;"><%= error.stack %></pre>
              <% } %>
              <% if (error.issueLink) { %>
                <a href="<%= error.issueLink %>">Linked issue</a>
              <% } %>
            <% }) %>
            <% if (failure.attachments.length && data.options.includeScreenshots) { %>
              <div>
                <% failure.attachments.filter(a => a.body && a.contentType.startsWith('image/')).forEach(attachment => { %>
                  <div>
                    <p class="muted"><%= attachment.name %></p>
                    <img src="<%= attachment.body %>" alt="<%= attachment.name %>" class="screenshot" />
                  </div>
                <% }) %>
              </div>
            <% } %>
          </article>
        <% }) %>
      </section>
    <% } %>

    <% if (showSection('summary', 'execution', 'defect')) { %>
      <section>
        <h2>Environment & Configuration</h2>
        <div class="grid cols-3">
          <div>
            <h3>Browsers</h3>
            <% data.environment.browsers.forEach(browser => { %>
              <span class="chip"><%= browser %></span>
            <% }) %>
          </div>
          <div>
            <h3>Devices</h3>
            <% data.environment.devices.forEach(device => { %>
              <span class="chip"><%= device %></span>
            <% }) %>
          </div>
          <div>
            <h3>Operating Systems</h3>
            <% data.environment.operatingSystems.forEach(os => { %>
              <span class="chip"><%= os %></span>
            <% }) %>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Project</th>
              <th>Viewport</th>
              <th>Headless</th>
            </tr>
          </thead>
          <tbody>
            <% data.environment.configMatrix.forEach(entry => { %>
              <tr>
                <td><%= entry.project %></td>
                <td><%= entry.viewport ?? 'default' %></td>
                <td><%= entry.headless %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </section>
    <% } %>

    <% if (showSection('summary', 'defect')) { %>
      <section>
        <h2>Trends & Historical Data</h2>
        <% if (data.history.length) { %>
          <canvas id="historyChart" height="200"></canvas>
        <% } else { %>
          <p class="muted">Historical data not available. Provide historicalDataPath to enable trends.</p>
        <% } %>
      </section>
    <% } %>

    <% if (showSection('summary')) { %>
      <section>
        <h2>Challenges & Lessons Learned</h2>
        <div class="two-column">
          <div>
            <h3>Challenges</h3>
            <ul>
              <% data.sections.challenges.forEach(item => { %>
                <li><%= item %></li>
              <% }) %>
            </ul>
          </div>
          <div>
            <h3>Lessons Learned</h3>
            <ul>
              <% data.sections.lessonsLearned.forEach(item => { %>
                <li><%= item %></li>
              <% }) %>
            </ul>
          </div>
        </div>
        <h3>Recommendations</h3>
        <ul>
          <% data.sections.recommendations.forEach(item => { %>
            <li><%= item %></li>
          <% }) %>
        </ul>
      </section>
    <% } %>

    <section>
      <h2>Summary & Conclusion</h2>
      <p>
        Suite executed <strong><%= data.summary.total %></strong> cases across
        <strong><%= data.environment.browsers.length %></strong> browsers with
        <strong><%= data.metrics.reliabilityScore %>%</strong> reliability. Attach this PDF to release readiness
        reviews, share with stakeholders, or archive as part of CI artifacts.
      </p>
      <% if (data.warnings.length) { %>
        <div>
          <h3>Warnings</h3>
          <ul>
            <% data.warnings.forEach(warning => { %>
              <li><%= warning %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    </section>

    <script>
      (() => {
        const summary = <%- JSON.stringify(data.summary) %>;
        const metrics = <%- JSON.stringify(data.metrics) %>;
        const history = <%- JSON.stringify(data.history) %>;

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
          new Chart(statusCtx, {
            type: 'pie',
            data: {
              labels: ['Passed', 'Failed', 'Skipped'],
              datasets: [
                {
                  data: [summary.passed, summary.failed, summary.skipped],
                  backgroundColor: ['#22c55e', '#ef4444', '#94a3b8']
                }
              ]
            },
            options: {
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        const metricsCtx = document.getElementById('metricsChart');
        if (metricsCtx) {
          new Chart(metricsCtx, {
            type: 'bar',
            data: {
              labels: ['Coverage', 'Reliability', 'Maintainability', 'Reusability'],
              datasets: [
                {
                  data: [
                    metrics.coveragePercent,
                    metrics.reliabilityScore,
                    metrics.maintainabilityIndex,
                    metrics.reusabilityScore
                  ],
                  backgroundColor: ['#0ea5e9', '#22c55e', '#f97316', '#a855f7']
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });
        }

        if (history.length) {
          const historyCtx = document.getElementById('historyChart');
          if (historyCtx) {
            new Chart(historyCtx, {
              type: 'line',
              data: {
                labels: history.map((entry) => new Date(entry.timestamp).toLocaleDateString()),
                datasets: [
                  {
                    label: 'Pass Rate',
                    data: history.map((entry) =>
                      entry.total ? Math.round((entry.passed / entry.total) * 100) : 0
                    ),
                    borderColor: '#22c55e',
                    tension: 0.3
                  },
                  {
                    label: 'Fail Rate',
                    data: history.map((entry) =>
                      entry.total ? Math.round((entry.failed / entry.total) * 100) : 0
                    ),
                    borderColor: '#ef4444',
                    tension: 0.3
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
          }
        }
      })();
    </script>
  </body>
</html>

